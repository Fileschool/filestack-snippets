<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.filestackapi.com/filestack-js/3.x.x/filestack.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Main Container -->
  <div class="container mx-auto max-w-7xl p-4">

    <!-- Profile Header -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <!-- Cover Photo -->
      <div class="relative group">
        <div id="cover-photo" class="h-52 md:h-72 bg-cover bg-center transition-all duration-500" style="background-image: url('https://placehold.co/1200x400/0d1b2a/ffffff?text=Netrunner+Interface');"></div>
        <div class="absolute inset-0 bg-black/30"></div>
        
        <!-- Cover Photo Change Button -->
        <button id="cover-photo-btn" class="absolute top-4 right-4 bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-full flex items-center space-x-2 transition duration-200 shadow-lg opacity-0 group-hover:opacity-100">
          <i class="fas fa-camera text-sm"></i>
          <span class="text-sm font-semibold">Change Cover</span>
        </button>
        
        <!-- Profile Picture Container -->
        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2">
             <img id="profile-pic" class="w-36 h-36 md:w-44 md:h-44 rounded-full border-4 border-white object-cover shadow-lg fade-in" src="https://placehold.co/400x400/e0e0e0/333333?text=Profile+Pic" alt="Profile Picture">
        </div>
      </div>

      <!-- Profile Info & Actions -->
      <div class="pt-24 md:pt-28 text-center px-4 pb-6">
        <h1 id="profile-name" class="text-3xl font-bold text-gray-800">Valerie Silverhand</h1>
        <p class="text-gray-500 mt-1">Netrunner · Tech Mercenary · Afterlife Legend</p>
        
        <div class="mt-6 flex justify-center items-center space-x-3">
          <button id="bttn-trigger-picker" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full flex items-center space-x-2 transition duration-200 shadow">
            <i class="fas fa-camera"></i>
            <span>Change Picture</span>
          </button>
          <button class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-6 rounded-full flex items-center space-x-2 transition duration-200 border border-gray-300 shadow">
            <i class="fas fa-edit"></i>
            <span>Edit Profile</span>
          </button>
        </div>
        <div id="upload-status" class="mt-4 text-sm font-medium h-6"></div>
      </div>
    </div>

    <!-- Profile Body -->
    <div class="flex flex-col lg:flex-row gap-8">

      <!-- Left Sidebar -->
      <aside class="lg:w-1/3 lg:sticky top-4 self-start space-y-6">
        <!-- Intro Card -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Intro</h3>
          <ul class="space-y-3 text-gray-700">
            <li class="flex items-center"><i class="fas fa-briefcase w-6 text-gray-500"></i><span>Works as a <span class="font-semibold">Freelance Netrunner</span></span></li>
            <li class="flex items-center"><i class="fas fa-graduation-cap w-6 text-gray-500"></i><span>Self-taught in the <span class="font-semibold">Night City Underground</span></span></li>
            <li id="profile-location" class="flex items-center"><i class="fas fa-map-marker-alt w-6 text-gray-500"></i><span>From <span class="font-semibold">Night City</span></span></li>
            <li id="profile-email" class="flex items-center"><i class="fas fa-envelope w-6 text-gray-500"></i><span>valerie.s@example.net</span></li>
          </ul>
        </div>

        <!-- Photos Card -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Photos</h3>
            <a href="#" class="text-blue-500 hover:underline text-sm font-semibold">See All</a>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <img src="https://placehold.co/200x200/ff0054/ffffff?text=Chrome" class="rounded-lg aspect-square object-cover" alt="photo 1">
            <img src="https://placehold.co/200x200/ff5400/ffffff?text=Night" class="rounded-lg aspect-square object-cover" alt="photo 2">
            <img src="https://placehold.co/200x200/ffbd00/ffffff?text=City" class="rounded-lg aspect-square object-cover" alt="photo 3">
            <img src="https://placehold.co/200x200/00f5d4/333333?text=Neon" class="rounded-lg aspect-square object-cover" alt="photo 4">
            <img src="https://placehold.co/200x200/9b5de5/ffffff?text=Tech" class="rounded-lg aspect-square object-cover" alt="photo 5">
            <img src="https://placehold.co/200x200/f15bb5/ffffff?text=Cyber" class="rounded-lg aspect-square object-cover" alt="photo 6">
          </div>
        </div>
      </aside>

      <!-- Main Content (Feed) -->
      <main class="flex-1 space-y-6">
        <!-- Create Post Card -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <div class="flex items-center space-x-3 border-b pb-4 mb-4">
            <img class="w-10 h-10 rounded-full object-cover profile-pic-mirror" src="https://placehold.co/400x400/e0e0e0/333333?text=Profile+Pic" alt="Current User Profile Pic">
            <input type="text" placeholder="What's on your mind, Valerie?" class="w-full bg-gray-100 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="flex justify-around">
            <button class="flex-1 flex items-center justify-center space-x-2 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition duration-200">
              <i class="fas fa-video text-red-500"></i>
              <span class="font-semibold text-sm">Live Gig</span>
            </button>
            <button class="flex-1 flex items-center justify-center space-x-2 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition duration-200">
              <i class="fas fa-photo-video text-green-500"></i>
              <span class="font-semibold text-sm">Braindance</span>
            </button>
            <button class="flex-1 flex items-center justify-center space-x-2 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition duration-200">
              <i class="fas fa-flag text-blue-500"></i>
              <span class="font-semibold text-sm">Milestone</span>
            </button>
          </div>
        </div>

        <!-- Feed Posts -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-4">
                <div class="flex items-center space-x-3">
                    <img class="w-10 h-10 rounded-full object-cover profile-pic-mirror" src="https://placehold.co/400x400/e0e0e0/333333?text=Profile+Pic" alt="Profile Pic">
                    <div>
                        <p class="font-semibold text-gray-800">Valerie Silverhand</p>
                        <p class="text-sm text-gray-500">8h ago · <i class="fas fa-globe-americas"></i></p>
                    </div>
                </div>
                <p class="mt-4 text-gray-700">Just cracked a Tier-5 ICE with a custom daemon. The dataflow was beautiful. Arasaka won't know what hit 'em. 🚀 #Netrunner #Cyberpunk #Heist</p>
            </div>
            <img src="https://placehold.co/800x500/1b263b/e0e1dd?text=Data+Stream" class="w-full" alt="Post Image">
            <div class="p-4">
                <div class="flex justify-between items-center text-gray-500 text-sm">
                    <span>128 Likes</span>
                    <span>15 Comments</span>
                </div>
                <hr class="my-2">
                <div class="flex justify-around text-gray-600">
                    <button class="flex-1 flex items-center justify-center space-x-2 py-2 rounded-lg hover:bg-gray-100 transition duration-200 font-semibold"><i class="far fa-thumbs-up"></i><span>Like</span></button>
                    <button class="flex-1 flex items-center justify-center space-x-2 py-2 rounded-lg hover:bg-gray-100 transition duration-200 font-semibold"><i class="far fa-comment-alt"></i><span>Comment</span></button>
                    <button class="flex-1 flex items-center justify-center space-x-2 py-2 rounded-lg hover:bg-gray-100 transition duration-200 font-semibold"><i class="far fa-share-square"></i><span>Share</span></button>
                </div>
            </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
        // Configuration - YOUR credentials
        const key = "yourapikey";
        const p = "policy";
        const s = "signature";
        const wfID = "workflow-id"; // Your profile workflow ID
        
        const btn = document.getElementById("bttn-trigger-picker");
        const coverBtn = document.getElementById("cover-photo-btn");
        const statusDiv = document.getElementById("upload-status");
        
        // Helper function to update all profile images
        function updateAllProfileImages(imageUrl) {
            // Update main profile picture with fade effect
            const mainPic = document.getElementById('profile-pic');
            mainPic.classList.remove('fade-in');
            setTimeout(() => {
                mainPic.src = imageUrl;
                mainPic.classList.add('fade-in');
            }, 50);
            
            // Update mirror images in posts
            document.querySelectorAll('.profile-pic-mirror').forEach(img => {
                img.src = imageUrl;
            });
        
        // Cover Photo Button Handler
        coverBtn.addEventListener("click", function () {
            const client = filestack.init(key, {
                security: {
                    policy: p,
                    signature: s,
                },
            });
            
            const coverOptions = {
                maxFiles: 1,
                maxSize: 50 * 1024 * 1024, // 50MB
                accept: ["image/*"],
                fromSources: ["local_file_system", "url", "webcam", "instagram", "facebook"],
                uploadInBackground: false,
                onFileUploadFailed: (file, error) => {
                    console.error('Cover upload failed:', error);
                    showStatus('❌ Cover upload failed: ' + error.message, 'text-red-600');
                },
                onUploadDone: (res) => {
                    if (res.filesUploaded.length > 0) {
                        const handle = res.filesUploaded[0].handle;
                        const filename = res.filesUploaded[0].filename;
                        
                        console.log('Cover photo uploaded:', handle, filename);
                        showStatus('✅ Cover photo updated!', 'text-green-600');
                        
                        // Create resized cover photo URL using CDN transformations
                        // Resize to 1200x400 and apply quality optimization
                        const coverUrl = `https://cdn.filestackcontent.com/resize=width:1200,height:400,fit:crop/quality=value:90/${handle}?policy=${p}&signature=${s}`;
                        
                        // Update cover photo immediately
                        updateCoverPhoto(coverUrl);
                        
                        // Clear status after 4 seconds
                        setTimeout(() => {
                            showStatus('');
                        }, 4000);
                    }
                },
            };
            
            const coverPicker = client.picker(coverOptions);
            coverPicker.open();
        });
        }
        
        // Helper function to update cover photo
        function updateCoverPhoto(imageUrl) {
            const coverDiv = document.getElementById('cover-photo');
            coverDiv.style.backgroundImage = `url('${imageUrl}')`;
        }
        
        // Helper function to show status
        function showStatus(message, color = 'text-blue-600') {
            statusDiv.className = `mt-4 text-sm font-medium h-6 ${color}`;
            statusDiv.innerHTML = message;
        }
        
        // Polling function for workflow status
        function pollWorkflowStatus(job, handle) {
            const wfStatusUrl = `https://cdn.filestackcontent.com/${key}/security=p:${p},s:${s}/workflow_status=job_id:${job}`;
            const wfRequestOptions = {
                method: "GET",
                redirect: "follow"
            };
            
            fetch(wfStatusUrl, wfRequestOptions)
                .then((response) => response.json())
                .then((data) => {
                    console.log('Workflow status:', data);
                    
                    if (data.status === "Finished") {
                        // Workflow finished
                        let finalImageUrl = null;
                        
                        // Extract the processed file URL from workflow results
                        // Look for the store result and get the data.url (the processed file CDN URL)
                        if (data.results) {
                            for (const key in data.results) {
                                const result = data.results[key];
                                // Check if this is a store result with data.url
                                if (result.data && result.data.url) {
                                    finalImageUrl = result.data.url;
                                    console.log('Found processed file URL:', finalImageUrl);
                                    break;
                                }
                            }
                        }
                        
                        if (finalImageUrl) {
                            // Add security credentials to the processed image URL
                            // The workflow result URL needs security parameters to be accessible
                            const securedImageUrl = finalImageUrl + `?policy=${p}&signature=${s}`;
                            
                            // Update with final processed image from workflow
                            updateAllProfileImages(securedImageUrl);
                            showStatus('✅ Profile picture updated successfully!', 'text-green-600');
                            
                            // Clear status after 4 seconds
                            setTimeout(() => {
                                showStatus('');
                            }, 4000);
                            
                            // Delete original file after successful processing
                            const deleteUrl = `https://www.filestackapi.com/api/file/${handle}?key=${key}&policy=${p}&signature=${s}`;
                            fetch(deleteUrl, {
                                method: "DELETE",
                                redirect: "follow"
                            })
                            .then((response) => response.text())
                            .then((result) => {
                                console.log('Original file deleted:', result);
                            })
                            .catch((error) => console.error('Delete error:', error));
                            
                        } else {
                            // Fallback to CDN transformation if workflow doesn't return URL
                            console.warn('No workflow URL found, using CDN transformation');
                            const fallbackUrl = `https://cdn.filestackcontent.com/resize=width:400,height:400,fit:crop/circle/${handle}`;
                            updateAllProfileImages(fallbackUrl);
                            showStatus('✅ Profile picture updated!', 'text-green-600');
                            
                            setTimeout(() => {
                                showStatus('');
                            }, 4000);
                        }
                        
                    } else if (data.status === "Failed") {
                        console.error('Workflow failed:', data);
                        showStatus('⚠️ Processing failed. Using original image.', 'text-yellow-600');
                        
                        // Use CDN transformation as fallback
                        const fallbackUrl = `https://cdn.filestackcontent.com/resize=width:400,height:400,fit:crop/circle/${handle}`;
                        updateAllProfileImages(fallbackUrl);
                        
                        setTimeout(() => {
                            showStatus('');
                        }, 4000);
                    } else {
                        // Still processing, poll again after 3 seconds
                        showStatus('⏳ Processing image... ' + (data.status || ''), 'text-blue-600');
                        setTimeout(() => pollWorkflowStatus(job, handle), 3000);
                    }
                })
                .catch((error) => {
                    console.error('Polling error:', error);
                    showStatus('⚠️ Error checking status. Using uploaded image.', 'text-yellow-600');
                    
                    // Fallback to simple CDN transformation
                    const fallbackUrl = `https://cdn.filestackcontent.com/resize=width:400,height:400,fit:crop/circle/${handle}`;
                    updateAllProfileImages(fallbackUrl);
                });
        }
        
        // Button click handler
        btn.addEventListener("click", function () {
            const client = filestack.init(key, {
                security: {
                    policy: p,
                    signature: s,
                },
            });
            
            const options = {
                maxFiles: 1,
                maxSize: 50 * 1024 * 1024, // 50MB
                accept: ["image/*"],
                fromSources: ["local_file_system", "url", "webcam", "instagram", "facebook"],
                uploadInBackground: false,
                onFileUploadFailed: (file, error) => {
                    console.error('Upload failed:', error);
                    showStatus('❌ Upload failed: ' + error.message, 'text-red-600');
                },
                onUploadDone: (res) => {
                    if (res.filesUploaded.length > 0) {
                        const handle = res.filesUploaded[0].handle;
                        const filename = res.filesUploaded[0].filename;
                        
                        console.log('File uploaded:', handle, filename);
                        
                        // Immediately show preview with CDN resize
                        const previewUrl = `https://cdn.filestackcontent.com/resize=width:400,height:400,fit:crop/circle/${handle}`;
                        updateAllProfileImages(previewUrl);
                        showStatus('⏳ Processing your new profile picture...', 'text-blue-600');
                        
                        // Start workflow
                        const wfUrl = `https://cdn.filestackcontent.com/security=p:${p},s:${s}/run_workflow=id:${wfID}/${handle}`;
                        const wfRequestOptions = {
                            method: "GET",
                            redirect: "follow"
                        };
                        
                        fetch(wfUrl, wfRequestOptions)
                            .then((response) => response.json())
                            .then((result) => {
                                if (result.jobid) {
                                    const job = result.jobid;
                                    console.log('Workflow started, job ID:', job);
                                    
                                    // Start polling after 2 seconds
                                    setTimeout(() => pollWorkflowStatus(job, handle), 2000);
                                } else {
                                    console.error('No job ID returned');
                                    showStatus('⚠️ Could not start processing. Using uploaded image.', 'text-yellow-600');
                                }
                            })
                            .catch((error) => {
                                console.error('Workflow start error:', error);
                                showStatus('⚠️ Could not process image. Using original.', 'text-yellow-600');
                            });
                    }
                },
            };
            
            const picker = client.picker(options);
            picker.open();
        });
        
        // Log configuration on load
        console.log('Filestack Profile Dashboard Initialized');
        console.log('API Key:', key);
        console.log('Workflow ID:', wfID);
        
        // Check policy expiry
        try {
            const decodedPolicy = JSON.parse(atob(p));
            if (decodedPolicy.expiry) {
                const expiryDate = new Date(decodedPolicy.expiry * 1000);
                console.log('Policy expires:', expiryDate.toLocaleString());
            }
        } catch (e) {
            console.log('Could not decode policy');
        }
    });
  </script>
</body>
</html>